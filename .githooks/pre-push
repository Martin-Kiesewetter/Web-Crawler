#!/bin/sh
#
# Pre-push hook: Runs PHPStan and PHPCS before allowing push
# Aborts push if any analysis finds errors
#
# Installation: Run this command once after cloning:
#   git config core.hooksPath .githooks
#

# Change to repository root
cd "$(git rev-parse --show-toplevel)" || exit 1

# ============================================
# 1. Run PHPStan analysis
# ============================================
echo "Running PHPStan analysis..."

RESULT=$(powershell.exe -NoProfile -Command "docker compose exec -T php sh -c 'php -d memory_limit=512M /var/www/html/vendor/bin/phpstan analyse -c /var/www/phpstan.neon'" 2>&1)
EXIT_CODE=$?

if [ $EXIT_CODE -ne 0 ]; then
    echo ""
    echo "=========================================="
    echo "PHPStan analysis FAILED!"
    echo "Push aborted."
    echo "=========================================="
    echo ""
    echo "$RESULT"
    echo ""
    echo "Please fix the errors above before pushing."
    exit 1
fi

echo "PHPStan analysis passed."

# ============================================
# 2. Run PHPCS (Code Style)
# ============================================
echo "Running PHPCS code style check..."

RESULT=$(powershell.exe -NoProfile -Command "docker compose exec -T php sh -c '/var/www/html/vendor/bin/phpcs --standard=PSR12 /var/www/html/classes /var/www/tests; exit \$LASTEXITCODE'" 2>&1)

# Check if there are actual errors (not just warnings)
# PHPCS output contains "FOUND X ERROR" if there are errors
if echo "$RESULT" | grep -q "FOUND [1-9][0-9]* ERROR"; then
    echo ""
    echo "=========================================="
    echo "PHPCS code style check FAILED!"
    echo "Push aborted."
    echo "=========================================="
    echo ""
    echo "$RESULT"
    echo ""
    echo "Run 'docker compose exec php composer phpcbf' to auto-fix style issues."
    exit 1
fi

if echo "$RESULT" | grep -q "WARNING"; then
    echo "PHPCS passed with warnings (lines > 120 chars allowed)."
else
    echo "PHPCS code style check passed."
fi
echo ""
echo "All checks passed. Proceeding with push..."
exit 0